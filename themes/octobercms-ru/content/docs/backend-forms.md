# Формы административной части

- [Настройка поведения формы](#configuring-form)
- [Поля форм](#form-fields)
- [Виджеты формы](#form-widgets)
- [Виды форм](#form-views)

**Поведение формы** настраивается контроллером для простого добавления функциональных форм на страницу в административной панели. Этот механизм обеспечивает поддержку трёх страниц: Создания, Обновления и Предосмотра. Страница предосмотра предназначена только для чтения версии страницы Обновления. При использовании такого подхода нет необходимости в поиске действий `create()`, `update()` и `preview()` в контроллерах - в нём вообще ничего не нужно менять. Всё что требуется, это предоставить соответствующий вид файлам.

Поведение формы зависит от [определённых полей](#form-fields) и [модели класса](database-model.md). Для того, чтобы использовать поведение формы, необходимо добавить его в поле `$implement` класса контроллера. Кроме того, свойства класса `$formConfig` и его значение должно указывать на файл YAML, используемого ддя настройки парметров поведения.

    namespace Acme\Blog\Controllers;

    class Categories extends \Backend\Classes\Controller {
        public $implement = [
            'Backend.Behaviors.FormController'
        ];

        public $formConfig = 'form_config.yaml';

> **На заметку:** Часто поведение форм и [списков](backend-lists.md) используются вместе и имеют один и тот же контроллер.

## <a name="configuring-form" class="anchor" href="#configuring-form"></a> Настройка поведения формы

Файл ностроек указывается в параметре `$formConfig` в формате YAML. Этот файл должен быть расположен в контроллерах [директории видов](backend-controllers-views-ajax.md/#introduction). Пример типичной настройки файла:

    # ===================================
    #  Настройки поведения формы
    # ===================================

    name: Категория блога
    form: @/plugins/acme/blog/models/post/fields.yaml
    modelClass: Acme\Blog\Post

    create:
        title: Новый пост блога

    update:
        title: Редактировать пост блога

    preview:
        title: Предосмотр поста блога

Следующие поля обязательны для формы файла настроек:

Параметр | Описание
------------- | -------------
**name** | название для объекта управляемый этой формой.
**form** | ссылка на файл определения [полей формы](#form-fields).
**modelClass** | название модели класса для загрузки и сохранения данных формы.

Список параметров ниже не является обязательным, определять их следует лишь для поддержки [Создания](#form-create-page), [Обновления](#form-update-page) или [Предосмотра](#form-preview-page) страниц.

Параметр | Описание
------------- | -------------
**defaultRedirect** | перенаправление страницы если ничего нет.
**create** | настройки для Создания страницы.
**update** | настройки для Обновления страницы.
**preview** | настройки для Предосмотра страницы.

### <a name="form-create-page" class="anchor" href="#form-create-page"></a> Создание страницы

Для поддержки Создания страницы нужно добавить в файл YAML:

    create:
        title: Новый пост блога
        redirect: acme/blog/posts/update/:id
        redirectClose: acme/blog/posts
        flash-save: Пост успешно создан!

Страницей Создания поддерживаются следующие параметры настройки:

Параметр | Описание
------------- | -------------
**title** | название страницы, может относиться к [строке локализации](plugin-localization.md).
**redirect** | перенаправление страницы после сохранения записи.
**redirectClose** | перенеправление страницы после сохранения записи и когда переменная поста **close** отправляется с запросом.
**flash-save** | мгновенное сообщение, отображаемое когда произошло сохранение записи, может относиться к [строке локализации](plugin-localization.md).

### <a name="form-update-page" class="anchor" href="#form-update-page"></a> Обновление страницы

Для поддержки Обновления страницы нужно добавить в файл YAML:

    update:
        title: Обновление поста блога
        redirect: acme/blog/posts
        flash-save: Посты успешно обновлён!
        flash-delete: Пост был удалён.

Страницей Обновления поддерживаются следующие параметры настройки:

Параметр | Описание
------------- | -------------
**title** | название страницы, может относиться к [строке локализации](plugin-localization.md).
**redirect** | перенаправление страницы после сохранения записи.
**redirectClose** | перенеправление страницы после сохранения записи и когда переменная поста **close** отправляется с запросом.
**flash-save** | мгновенное сообщение, отображаемое когда произошло сохранение записи, может относиться к [строке локализации](plugin-localization.md).
**flash-delete** | мгновенное сообщение, отображаемое когда произошло удаление записи, может относиться к [строке локализации](plugin-localization.md).

### <a name="form-preview-page" class="anchor" href="#form-preview-page"></a> Предосмотр страницы

Для поддержки Предосмотра страницы нужно добавить в файл YAML:

    preview:
        title: Предосмотр поста блога

Страницей Предосмотра поддерживаются следующие параметры настройки:

Параметр | Описание
------------- | -------------
**title** | название страницы, может относиться к [строке локализации](plugin-localization.md).

## <a name="form-fields" class="anchor" href="#form-fields"></a> Поля формы

Поля формы определяются с помощью файла YAML. Натройка полей формы используется поведением формы для создания элементов управления формы и привязки их к модели полей. Этот файл распологается в подкаталоге папки **моделей** плагина. Название подкаталога совпадает с именем класса модели и пишется строчными буквами. Имя фала не имеет значения, но **fields.yaml** и **form_fields.yaml** даёт возможность понять к чему этот файл имеет отношение. Пример расположения файла полей формы: 

    plugins/
      acme/
        blog/
          models/                <=== Каталог моделей плагина
            post/                <=== Каталог настроек модели
              form_fields.yaml   <=== Файл настроек полей формы модели
            Post.php             <=== Класс модели


Поля могут быть размещены в трёх областях, **вне области**, **главной области** или **второстепенной области**. Следующий пример показывает типичное содержание файла определения полей формы.

    # ===================================
    #  Определение полей формы
    # ===================================

    fields:
      blog_title:
        label: Название блога
        description: название данного блога

      published_at:
        label: Дата публикации
        description: когда это сообщение в блоге было опубликовано
        type: datetime

      [...]

    tabs:
      fields:
        [...]

    secondaryTabs:
      fields:
        [...]

### <a name="form-field-options" class="anchor" href="#form-field-options"></a> Параметры полей

Для каждого поля можно указать эти параметры (если применимо):

Параметр | Описание
------------- | -------------
**label** | отображаемое название поля формы для пользователя.
**type** | определяет какой тип поля использовать (о типах полей ниже). По умолчанию: text.
**span** | по какой стороне выравнивать поле. Параметры: auto, left, right, full. По умолчанию: auto.
**size** | размер поля, в котором он указывается (например text area). Параметры: tiny, small, large, huge, giant.
**placeholder** | если поле поддерживает значение плейсхолдера.
**comment** | размещает текст описания ниже поля.
**commentAbove** | размещает текст описания выше поля.
**default** | определяет значение по умолчанию для поля.
**tab** | размещает поле во- вкладке.
**cssClass** | указывает CSS класс контейнеру поля.
**disabled** | затемняет поле, если установлено значение true. Параметры: true, false.
**stretch** | указывает, может ли поле растягиваться по высоте родительского элемента.

### <a name="form-field-types" class="anchor" href="#form-field-types"></a> Типы полей

`text` - выводит текстовый блок в одну линию. Этот тип указывается по умолчанию, если тип не указан.

    blog_title:
      label: Название блога
      type: text

`password ` - выводит поле для ввода пароля в одну линию.

    user_password:
      label: Пароль
      type: password

`textarea` - выводит текстовую область в несколько строк. Поддерживает несколько параметров указывающих его размер: tiny, small, large, huge, giant.

    blog_contents:
      label: Содержание
      type: textarea
      size: large

`dropdown` - выводит меню выбора с указанными параметрами. Есть 3 способа указать параметры для выбора. В первом варианте параметры определяются наместе, то есть в файле YAML:

    status:
      label: Статус поста блога
      type: dropdown
      options:
        draft: В проекте
        published: Опубликован
        archived: В архиве

Второй способ указывает параметры с методом, обвявленным в одном из классов моделей. Если параметры не указаны, фреймворк ожидает метод с именем `get*Field*Options()` который должен быть определён в модели. Чтобы определить параметры как в примере выше, модель должна иметь метод ``getStatusOptions()``. Данный метод должен содержать массив параметров в формате **key => label**.

    status:
      label: Статус поста блога
      type: dropdown


В третьем способе используется специальный метод, объявленный в одном из классов моделей. В следующем примере, метод `listStatuses()` должен быть определён в модели класса.

    status:
      label: Статус поста блога
      type: dropdown
      options: listStatuses

`radio` - выводит список радио параметров, в котором выбрать можно лишь один параметр из всех.

    security_level:
      label: Уровень доступа
      type: radio
      options:
        all: Полный
        registered: Только для зарегистрированных
        guests: Только для гостей

Радио списки поддерживают описание параметров выбора.

    security_level:
      label: Уровень доступа
      type: radio
      options:
        all: [Полный, Гости и клиенты будут иметь доступ к данной странице.]
        registered: [Только для зарегистрированных, Только авторизованные посетители смогут увидеть данную страницу.]
        guests: [Только для гостей, Просмотреть данную страницу смогут только неавторизованные пользователи.]

Радио списки поддерживают 3 метода определения параметов, так же как и в меню выбора (dropdown). Для радио списков метод может содержать как простой массив: **key => value** так и массив с описанием параметров: **key => [Название, Описание]**

`widget` - этот `тип` полей может обращаться непосредственно к имени класса виджета или зарегистрированному имени псевдонима.

    blog_content:
      type: Backend\FormWidgets\RichEditor
      size: huge
      options: [...]


## <a name="form-widgets" class="anchor" href="#form-widgets"></a> Виджеты форм

Есть различные виджеты плагинов, в стандартном комплекте, обеспечивающие собственными виджетами пользовательские формы. Подробней можно почитать на странице [Виджетов](backend-widgets.md) системы управления.

- [Визуальный редактор / WYSIWYG](#widget-richeditor)
- [Редактор кода](#widget-codeeditor)
- [Файловый загрузчик](#widget-fileupload)
- [Выбор даты](#widget-datepicker)
- [Отношение](#widget-relation)
- [Поиск записей](#widget-recordfinder)


### <a name="widget-richeditor" class="anchor" href="#widget-richeditor"></a> Визуальный редактор / WYSIWYG

`richeditor` - выводит визуальный текстовый редактор для насыщенного форматирования текста, известного так же как WYSIWYG редактор.

    html_content:
      type: richeditor
      size: huge


### <a name="widget-codeeditor" class="anchor" href="#widget-codeeditor"></a> Редактор кода

`codeeditor` - выводит простой текстовый редактор для форматирования или разметки кода. Параметры могут быть унаследованы из настроек редактора в административной части для Администратора.

    css_content:
      type: codeeditor
      size: huge
      language: html

Параметр  | Описание
------------- | -------------
**language** | язык программирования, для примера: php, css, js, html. По умолчанию: php.
**showGutter** | отображать номера строк. По умолчанию: true.
**wrapWords** | умещать длинные строки в область редактора, без горизонтальной прокрутки. По умолчанию: true.
**fontSize** | размер шрифта. По умолчанию: 12.


### <a name="widget-fileupload" class="anchor" href="#widget-fileupload"></a> Файловый загрузчик

`fileupload` - выводит файловый загрузчик для изображений или обычных файлов. Название поля необходимо использовать относительно attachOne или attachMany.

    avatar:
      label: Аватар
      type: fileupload
      mode: image
      imageHeight: 260
      imageWidth: 260

Параметр  | Описание
------------- | -------------
**mode** | возможность работаться в двух режимах: file и image. По умолчанию: file.
**imageWidth** | если используется режим работы с изображениями то изображение изменится до заданного размера, по ширине.
**imageWidth** | если используется режим работы с изображениями то изображение изменится до заданного размера, по высоте.
**fileTypes** | расширения файлов, которые будут поддерживаться для загрузки, необязательный параметр. Например: zip,txt


### <a name="widget-datepicker" class="anchor" href="#widget-datepicker"></a> Выбор даты

`datepicker` - выводит текстовую область для выбора даты и времяни.

    published_at:
        label: Опубликован
        type: datepicker
        mode: date

Параметр  | Описание
------------- | -------------
**mode** | ожидаемое значение, такое как date, datetime или time. По умолчанию: datetime.


### <a name="widget-relation" class="anchor" href="#widget-relation"></a> Связывание

`relation` - выводит выпадающий список (dropdown) или список флажков (checkbox), в зависимости от типа поля, с которым происходит связь. Особые связи отображают выпадающий список, множественные связи отображают список флажков для множественного выбора.

    categories:
        label: Категории
        type: relation
        nameFrom: title

Параметр  | Описание
------------- | -------------
**nameFrom** | название колонки используемое для имени связывания. По умолчанию: name.
**descriptionFrom** | название колонки используемое для описания связывания (не обязательное). По умолчанию: description.
**emptyOption** | текст, который отображается в списке если ничего не выбрано.


### <a name="widget-recordfinder" class="anchor" href="#widget-recordfinder"></a> Поиск записей

`recordfinder` - выводит поле с деталями связанной записи. Расширение этого поля отображает всплывающий, искомый в большом количестве записей список.

    user:
        label: Пользователь
        type: recordfinder
        list: ~/plugins/rainlab/user/models/user/columns.yaml
        prompt: Нажмите кнопку %s для поиска пользователя
        nameFrom: name
        descriptionFrom: email

Параметр  | Описание
------------- | -------------
**nameFrom** | название колонки используемое для имени связывания. По умолчанию: name.
**descriptionFrom** | название колонки используемое для описания связывания (не обязательное). По умолчанию: description.
**prompt** | текст, который отображается в списке если ни одна запись не выбрана. Символ `%s` отображает значёк поиска.
**list** | массив настроек или ссылка на определённый файл столбца списка, подробней о [списке столбцов](backend-lists.md#list-columns).


## <a name="form-views" class="anchor" href="#form-views"></a> Виды форм

Для каждой страницы поддерживаемых форм - [Создания](#form-create-page), [Обновления](#form-update-page) и [Предосмотра](#form-preview-page) должен быть создан [файл вида](#introduction) с соответствующим именем - **create.htm**, **update.htm** и **preview.htm**.

Это поведение формы добавляет два новых класса к контроллеру: `formRender()` и `formRenderPreview()`. Эти методы выводят элементы управления формы, настроенные с помощью файла YAML, описанного выше.

### <a name="form-create-view" class="anchor" href="#form-create-view"></a> Вид Создания

Вид **create.htm** представляет собой страницу Создания, которая позволяет пользователям создавать новые записи. В основном, страница Создания содержит меню навигации (breadcrumbs), саму форму и кнопки. Атрибут **data-request** вызывает `onSave` AJAX обработчик, поддерживаемый поведением формы. Ниже приводится пример типичного содержания формы create.htm.

    <div class="control-breadcrumb">
        <ul>
            <li><a href="<?= Backend::url('acme/blog/categories') ?>">Категории блога</a></li>
            <li><?= e($this->pageTitle) ?></li>
        </ul>
    </div>

    <?= Form::open(['class'=>'layout-item stretch layout-column']) ?>

        <?= $this->formRender() ?>

        <div class="form-buttons layout-item fix">
            <div class="loading-indicator-container">
                <button 
                    type="button" 
                    data-request="onSave" 
                    data-request-data="close:true" 
                    data-hotkey="ctrl+enter"
                    data-hotkey-mac="cmd+enter"
                    data-load-indicator="Создание категории..." 
                    class="btn btn-default">
                    Создать и выйти
                </button>
                <span class="btn-text"> или 
                <a href="<?= Backend::url('acme/blog/categories') ?>">Отменить</a></span>
            </div>
        </div>

    <?= Form::close() ?>

### <a name="form-update-view" class="anchor" href="#form-update-view"></a> Вид Обновления

Вид **update.htm** представляет собой страницу Обновления, которая позволяет пользователям обновлять или удалять существующие записи. Стандартная страница Обновления содержит меню навигации, форму и кнопки. Страница Обновления похожа на страницу Создания, но, как правило, в ней имеется кнопка для удаления. Атрибут **data-request** вызывает `onSave` AJAX обработчик, поддерживаемый поведением формы. Ниже приводится пример типичного содержания формы update.htm.

    <div class="control-breadcrumb">
        <ul>
            <li><a href="<?= Backend::url('acme/blog/posts') ?>">Категории блога</a></li>
            <li><?= e($this->pageTitle) ?></li>
        </ul>
    </div>

    <?= Form::open(['class'=>'layout-item stretch layout-column']) ?>

        <?= $this->formRender() ?>

        <div class="form-buttons layout-item fix">
            <div class="loading-indicator-container">
                <button 
                    type="button" 
                    data-request="onSave" 
                    data-request-data="close:true" 
                    data-hotkey="ctrl+enter"
                    data-hotkey-mac="cmd+enter"
                    data-load-indicator="Сахранение категории..." 
                    class="btn btn-default">
                    Сохранить и закрыть
                </button>
                <button 
                    type="button" 
                    class="oc-icon-trash-o btn-icon danger pull-right" 
                    data-request="onDelete" 
                    data-load-indicator="Удалить категорию..." 
                    data-request-confirm="Вы уверены что хотите удалить категорию?">
                </button>

                <span class="btn-text"> или 
                <a href="<?= Backend::url('acme/blog/categories') ?>">Отменить</a></span>
            </div>
        </div>
    <?= Form::close() ?>

### <a name="form-preview-view" class="anchor" href="#form-preview-view"></a> Вид Предосмотра

Вид **preview.htm** представляет собой общую страницу предварительного просмотра, что позволяет пользователям просматривать существующие записи в режиме только для чтения. Типично для такой страницы содержание меню навигации и самой формы. Ниже приводится пример такой формы preview.htm.

    <div class="control-breadcrumb">
        <ul>
            <li><a href="<?= Backend::url('rainlab/blog/categories') ?>">Категории блога</a></li>
            <li><?= e($this->pageTitle) ?></li>
        </ul>
    </div>

    <?= $this->formRenderPreview() ?>


### Переопределение поведения формы по умолчанию

Есть также возможность использовать собственную логику вместе с формой. При этом можно использовать свои методы действий `create()`, `update()` или `preview()` в контроллере, после чего вызывать их поведением формы.

    public function update($recordId, $context = null)
    {
        //
        // Любой пользовательский код
        //

        // Вызов метода update() поведения FormController
        return $this->getClassExtension('Backend.Behaviors.FormController')->update($recordId, $context);
    }